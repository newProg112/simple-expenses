<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Expenses</title>

  <style>
    :root{
      --accent:#0077B6;
      --bg:#ffffff;
      --text:#1f2933;
      --muted:#6b7280;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:16px;
      border-bottom:1px solid rgba(0,0,0,.1);
    }

    .wrap{
      max-width:900px;
      margin:auto;
      padding:20px;
    }

    .btn{
      background:var(--accent);
      color:white;
      padding:10px 14px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .card{
      border:1px solid rgba(0,0,0,.1);
      border-radius:16px;
      padding:16px;
      margin-top:16px;
    }

    /* Hide attachment for now (Spark plan) */
    .hidden { display: none !important; }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <strong>Simple Expenses</strong>
  </div>
</header>

<div class="wrap">

  <h1>Simple Expenses</h1>

    <p>Track your expenses and receipts.</p>

    <!-- LOGIN CARD -->
    <div class="card" id="loginCard">

    <h3>Sign in</h3>

    <input id="email" type="email" placeholder="Email"
        style="width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ccc;">

    <input id="password" type="password" placeholder="Password"
        style="width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ccc;">

    <button class="btn" id="btnSignIn" style="margin-top:12px;">
    Sign in
        </button>

        <button class="btn" id="btnSignUp" style="margin-top:8px; background:#6b7280;">
        Create account
        </button>
    </div>


    <!-- APP AREA -->
    <div id="appArea" style="display:none;">

    <button class="btn" id="btnSignOut">Sign out</button>

    <button class="btn" id="btnAddExpense" style="margin-left:8px;">Add expense</button>

      <div class="card" id="summaryCard" style="display:none;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
          <div>
            <div style="font-weight:700; font-size:16px;">This month</div>
            <div style="color:var(--muted);" id="summaryLine">—</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <label style="display:flex; gap:8px; align-items:center; color:var(--muted); font-weight:600;">
              Month
              <input id="monthPick" type="month"
                style="padding:8px 10px; border-radius:10px; border:1px solid #ccc;">
            </label>

            <button class="btn" id="btnExportCsv" style="background:#111827;">Export CSV</button>
          </div>
        </div>

        <div id="summaryBadges" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;"></div>
      </div>

  <div class="card" id="expenseForm" style="display:none;">
    <h3 style="margin-top:0;">New expense</h3>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <input id="expDate" type="date"
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">

      <input id="expSupplier" placeholder="Supplier"
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">

      <input id="expCategory" placeholder="Category (e.g. Travel)"
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">

      <input id="expNet" type="number" step="0.01" placeholder="Net (£)"
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">
      
      <input id="expReceipt" class="hidden" type="file" accept="image/*,.pdf"
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:10px;">
    </div>

    <textarea id="expNotes" placeholder="Notes (optional)"
      style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #ccc;"></textarea>

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn" id="btnSaveExpense">Save</button>
      <button class="btn" id="btnCancelExpense" style="background:#6b7280;">Cancel</button>
    </div>

    <div id="formMsg" style="margin-top:10px; color:#b91c1c;"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Expenses</h3>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center;">
      <input id="searchBox" placeholder="Search supplier / notes…"
        style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.15);">

      <select id="categoryFilter"
        style="padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.15); min-width:200px;">
        <option value="">All categories</option>
      </select>

      <button class="btn" id="btnClearFilters" style="background:#6b7280;">Clear</button>
    </div>

    <div id="expensesList">No expenses yet.</div>
  </div>

    </div>

</div>

<!-- Firebase (place at bottom of body) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc,
    deleteDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyA4Ix7zn0Tgow4V2djHbqF4LIWnk6TD4Hk",
    authDomain: "simple-expenses-8ab54.firebaseapp.com",
    projectId: "simple-expenses-8ab54",
    storageBucket: "simple-expenses-8ab54.firebasestorage.app",
    messagingSenderId: "902097301037",
    appId: "1:902097301037:web:a556848244815a3eca52a4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  console.log("Firebase ready ✅", { auth, db, storage });

  // --- Elements ---
  const loginCard = document.getElementById("loginCard");
  const appArea = document.getElementById("appArea");

  const btnSignIn = document.getElementById("btnSignIn");
  const btnSignUp = document.getElementById("btnSignUp");
  const btnSignOut = document.getElementById("btnSignOut");

  const btnAddExpense = document.getElementById("btnAddExpense");
  const expenseForm = document.getElementById("expenseForm");
  const btnSaveExpense = document.getElementById("btnSaveExpense");
  const btnCancelExpense = document.getElementById("btnCancelExpense");
  const expensesList = document.getElementById("expensesList");
  const formMsg = document.getElementById("formMsg");

  // --- Summary elements ---
  const summaryCard = document.getElementById("summaryCard");
  const summaryLine = document.getElementById("summaryLine");
  const summaryBadges = document.getElementById("summaryBadges");
  const monthPick = document.getElementById("monthPick");
  const btnExportCsv = document.getElementById("btnExportCsv");

  const searchBox = document.getElementById("searchBox");
  const categoryFilter = document.getElementById("categoryFilter");
  const btnClearFilters = document.getElementById("btnClearFilters");

  let editingId = null;          // null = creating, otherwise editing this doc id
  let latestDocsById = new Map(); // store latest snapshot docs for editing

  let latestDocs = []; // keep the last snapshot array for filtering

  searchBox.addEventListener("input", () => applyFilters());

  categoryFilter.addEventListener("change", () => applyFilters());

  btnClearFilters.addEventListener("click", () => {
    searchBox.value = "";
    categoryFilter.value = "";
    applyFilters();
  });

  // --- Delete handler (event delegation) ---
  expensesList.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-action][data-id]");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const id = btn.getAttribute("data-id");
    if (!action || !id) return;

    const user = auth.currentUser;
    if (!user) return alert("You must be signed in.");

    if (action === "delete") {
      if (!confirm("Delete this expense?")) return;
      try {
        await deleteDoc(doc(db, "users", user.uid, "expenses", id));
        // if we were editing this item, reset form state
        if (editingId === id) resetFormState();
      } catch (err) {
        alert(err.message);
      }
    }

    if (action === "edit") {
      const snapDoc = latestDocsById.get(id);
      if (!snapDoc) return alert("Could not load this expense to edit.");

      const data = snapDoc.data();

      editingId = id;
      document.querySelector("#expenseForm h3").textContent = "Edit expense";
      btnSaveExpense.textContent = "Update";

      document.getElementById("expDate").value = data.date || "";
      document.getElementById("expSupplier").value = data.supplier || "";
      document.getElementById("expCategory").value = data.category || "";
      document.getElementById("expNet").value = typeof data.net === "number" ? String(data.net) : "";
      document.getElementById("expNotes").value = data.notes || "";

      showForm(true);
      formMsg.textContent = "";
    }
  });

  // --- Auth actions ---
  btnSignUp.addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      alert("Account created ✅");
    } catch (err) {
      alert(err.message);
    }
  });

  btnSignIn.addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert(err.message);
    }
  });

  btnSignOut.addEventListener("click", async () => {
    await signOut(auth);
  });

  // --- UI helpers ---
  function renderExpenses(docs) {
    // cache docs so we can load data when editing
    latestDocsById = new Map(docs.map(d => [d.id, d]));

    if (!docs.length) {
      expensesList.textContent = "No expenses yet.";
      return;
    }

    expensesList.innerHTML = docs.map(d => {
      const data = d.data();
      const date = data.date || "";
      const supplier = data.supplier || "";
      const category = data.category || "";
      const net = typeof data.net === "number" ? data.net.toFixed(2) : "0.00";
      const notes = data.notes ? ` • ${data.notes}` : "";
      const receiptLink = data.receipt?.url
        ? ` • <a href="${data.receipt.url}" target="_blank" rel="noopener" style="color:var(--accent); font-weight:600; text-decoration:none;">View receipt</a>`
        : "";

      return `<div style="padding:10px 0; border-top:1px solid rgba(0,0,0,.08); display:flex; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:600;">£${net}
            <span style="color:var(--muted); font-weight:400;">(${category})</span>
          </div>
          <div style="color:var(--muted);">${date} • ${supplier}${notes}${receiptLink}</div>
        </div>

        <div style="display:flex; gap:8px;">
          <button class="btn" data-action="edit" data-id="${d.id}" style="background:#0ea5e9; height:40px;">
            Edit
          </button>
          <button class="btn" data-action="delete" data-id="${d.id}" style="background:#ef4444; height:40px;">
            Delete
          </button>
        </div>
      </div>`;
    }).join("");
  }

  function hydrateFilters(docs) {
    // build unique category list from current docs
    const cats = new Set();
    for (const d of docs) {
      const c = (d.data().category || "").trim();
      if (c) cats.add(c);
    }

    const current = categoryFilter.value;

    categoryFilter.innerHTML =
      `<option value="">All categories</option>` +
      [...cats].sort((a, b) => a.localeCompare(b)).map(c =>
        `<option value="${c}">${c}</option>`
      ).join("");

    // try to keep user selection if it still exists
    if ([...categoryFilter.options].some(o => o.value === current)) {
      categoryFilter.value = current;
    }
  }

  function applyFilters() {
    const q = (searchBox.value || "").trim().toLowerCase();
    const cat = categoryFilter.value || "";

    const filtered = latestDocs.filter(d => {
      const data = d.data();
      const supplier = (data.supplier || "").toLowerCase();
      const notes = (data.notes || "").toLowerCase();
      const category = (data.category || "").trim();

      const matchesText = !q || supplier.includes(q) || notes.includes(q);
      const matchesCat = !cat || category === cat;

      return matchesText && matchesCat;
    });

    renderExpenses(filtered);
  }

  function showForm(show) {
    formMsg.textContent = "";
    expenseForm.style.display = show ? "block" : "none";
  }

  function resetFormState() {
    editingId = null;
    document.querySelector("#expenseForm h3").textContent = "New expense";
    btnSaveExpense.textContent = "Save";

    document.getElementById("expDate").value = "";
    document.getElementById("expSupplier").value = "";
    document.getElementById("expCategory").value = "";
    document.getElementById("expNet").value = "";
    document.getElementById("expNotes").value = "";
    document.getElementById("expReceipt").value = ""; // harmless even though hidden
  }

  function monthKeyFromDateStr(dateStr) {
    // expects "YYYY-MM-DD"
    return (dateStr || "").slice(0, 7); // "YYYY-MM"
  }

  function formatGBP(n) {
    const v = Number(n);
    const safe = Number.isFinite(v) ? v : 0;
    return safe.toLocaleString("en-GB", { style: "currency", currency: "GBP" });
  }

  function calcSummary(docs, monthKey) {
    const rows = docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(x => monthKeyFromDateStr(x.date) === monthKey);

    const total = rows.reduce((sum, r) => sum + (Number(r.net) || 0), 0);

    // Category totals
    const byCat = new Map();
    for (const r of rows) {
      const cat = (r.category || "Uncategorised").trim() || "Uncategorised";
      byCat.set(cat, (byCat.get(cat) || 0) + (Number(r.net) || 0));
    }

    const topCats = [...byCat.entries()]
      .sort((a, b) => b[1] - a[1])
      .slice(0, 6);

    return { rows, total, topCats };
  }

  function renderSummary(docs) {

    const monthKey = monthPick.value;
    if (!monthKey) return;

    const { rows, total, topCats } = calcSummary(docs, monthKey);

    // Always show summary card
    summaryCard.style.display = "block";

    // Summary line
    summaryLine.textContent =
      `${formatGBP(total)} across ${rows.length} expense${rows.length === 1 ? "" : "s"}`;

    // Category badges
    if (!rows.length) {
      summaryBadges.innerHTML =
        `<div style="color:var(--muted); font-weight:600;">
          No expenses in this month yet.
        </div>`;
      return;
    }

    summaryBadges.innerHTML = topCats.map(([cat, amt]) => {
      return `<div style="
        padding:8px 10px;
        border:1px solid rgba(0,0,0,.10);
        border-radius:999px;
        background:#fff;
        font-weight:700;
        font-size:13px;
      ">
        <span style="color:var(--muted); font-weight:600;">${cat}</span>
        <span style="margin-left:8px;">${formatGBP(amt)}</span>
      </div>`;
    }).join("");
  }

  function exportCsvForMonth(docs) {
    const monthKey = monthPick.value;
    const { rows } = calcSummary(docs, monthKey);

    const header = ["Date", "Supplier", "Category", "Net", "Notes"];
    const lines = [header];

    for (const r of rows) {
      lines.push([
        r.date || "",
        (r.supplier || "").replaceAll('"', '""'),
        (r.category || "").replaceAll('"', '""'),
        String(Number(r.net) || 0),
        (r.notes || "").replaceAll('"', '""')
      ]);
    }

    const csv = lines
      .map(cols => cols.map(v => `"${String(v)}"`).join(","))
      .join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `simple-expenses_${monthKey}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  // --- Expense form buttons ---
  btnAddExpense.addEventListener("click", () => {
    resetFormState();
    showForm(true);
  });
  btnCancelExpense.addEventListener("click", () => {
    resetFormState();
    showForm(false);
  });

  btnSaveExpense.addEventListener("click", async () => {
    formMsg.textContent = "";

    const user = auth.currentUser;
    if (!user) {
      formMsg.textContent = "You must be signed in.";
      return;
    }

    const date = document.getElementById("expDate").value;
    const supplier = document.getElementById("expSupplier").value.trim();
    const category = document.getElementById("expCategory").value.trim();
    const netRaw = document.getElementById("expNet").value;
    const notes = document.getElementById("expNotes").value.trim();
    // Attachments disabled for now (Spark plan)
    const receiptFile = null;

    const net = Number(netRaw);

    if (!date) return (formMsg.textContent = "Please pick a date.");
    if (!supplier) return (formMsg.textContent = "Please enter a supplier.");
    if (!category) return (formMsg.textContent = "Please enter a category.");
    if (!Number.isFinite(net) || net <= 0) return (formMsg.textContent = "Net must be a number > 0.");

    try {
      const ref = collection(db, "users", user.uid, "expenses");

      let receipt = null;

      if (receiptFile) {
        const safeName = receiptFile.name.replaceAll(" ", "_");
        const path = `users/${user.uid}/receipts/${Date.now()}_${safeName}`;
        const fileRef = storageRef(storage, path);

        await uploadBytes(fileRef, receiptFile);
        const url = await getDownloadURL(fileRef);

        receipt = {
          url,
          path,
          name: receiptFile.name,
          type: receiptFile.type || "unknown"
        };
      }

      if (editingId) {
        // update existing
        await updateDoc(doc(db, "users", user.uid, "expenses", editingId), {
          date,
          supplier,
          category,
          net,
          notes
          // keep createdAt as-is
        });
      } else {
        // create new
        await addDoc(ref, {
          date,
          supplier,
          category,
          net,
          notes,
          receipt,
          createdAt: serverTimestamp()
        });
      }

      // reset + hide
      resetFormState();
      showForm(false);
    } catch (err) {
      formMsg.textContent = err.message;
    }
  });

  // --- Firestore live listener (per user) ---
  let unsubscribeExpenses = null;

  onAuthStateChanged(auth, (user) => {
    console.log("Auth state:", user ? user.email : "signed out");

    // stop previous listener when signing out or switching user
    if (unsubscribeExpenses) {
      unsubscribeExpenses();
      unsubscribeExpenses = null;
    }

    if (user) {
      loginCard.style.display = "none";
      appArea.style.display = "block";

      // default month picker to current month once
      if (!monthPick.value) {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        monthPick.value = `${yyyy}-${mm}`;
      }

      // month change re-renders summary using latest docs cache
      monthPick.onchange = () => {
        renderSummary([...latestDocsById.values()]);
      };

      // export
      btnExportCsv.onclick = () => {
        exportCsvForMonth([...latestDocsById.values()]);
      };

      summaryCard.style.display = "block";

      const ref = collection(db, "users", user.uid, "expenses");
      const q = query(ref, orderBy("createdAt", "desc"));

      unsubscribeExpenses = onSnapshot(q, (snap) => {
        const docs = snap.docs;
        latestDocs = docs;

        hydrateFilters(docs);
        applyFilters();        // <-- renders the filtered list (instead of renderExpenses)

        renderSummary(docs);   // summary stays based on ALL docs (good)
      }, (err) => {
        console.error(err);
        expensesList.textContent = "Could not load expenses.";
      });

    } else {
      loginCard.style.display = "block";
      appArea.style.display = "none";

      summaryCard.style.display = "none";

      expensesList.textContent = "No expenses yet.";
      showForm(false);
    }
  });
</script>

</body>
</html>